<div class="auth-main">
  <div class="auth-wrapper v3">
    <div class="auth-form">
      
      <!-- Logo & Header -->
      <div class="d-flex align-items-center auth-header mb-4">
        <!-- Logo -->
        <a href="#" class="me-3">
          <img src="assets/images/logo.png" alt="logo" width="100px"/>
        </a>

        <!-- Text Block -->
        <div class="text-start">
          <h6 class="mb-1 fw-bold">LUNA PACKAGING</h6>
          <p class="m-0 small text-muted">Client Ordering & Management System</p>
        </div>
      </div>

      <!-- Card -->
      <div class="card my-5">
        <div class="card-body">

          <!-- STEP 1: Email Input -->
          <div *ngIf="currentStep === 'email'">
            
            <!-- Back to Login -->
            <div class="mb-3">
              <a (click)="goToLogin()" class="text-primary cursor-pointer d-flex align-items-center">
                <i class="fa fa-arrow-left me-2"></i>
                Back to Login
              </a>
            </div>

            <!-- Title -->
            <div class="text-center mb-4">
              <div class="mb-3">
                <i class="fa fa-lock fs-1 text-primary"></i>
              </div>
              <h3 class="mb-2"><b>Forgot Password?</b></h3>
              <p class="text-muted">
                Enter your email address and we'll send you an OTP to reset your password.
              </p>
            </div>

            <!-- Email Form -->
            <div class="form-group mb-4">
              <label class="form-label" for="email">Email Address</label>
              <input 
                type="email" 
                class="form-control" 
                id="email" 
                placeholder="Enter your email address" 
                [(ngModel)]="emailAddress"
                [disabled]="isSubmittingEmail"
                (keyup.enter)="submitEmail()" />
            </div>

            <!-- Submit Button -->
            <div class="d-grid">
              <button 
                type="button" 
                class="btn btn-primary"  
                (click)="submitEmail()"        
                [disabled]="isSubmittingEmail">
                <app-loader-material *ngIf="isSubmittingEmail"></app-loader-material>
                <span>{{ isSubmittingEmail ? 'Sending OTP...' : 'Send OTP' }}</span>
              </button>
            </div>

          </div>

          <!-- STEP 2: OTP Verification -->
          <div *ngIf="currentStep === 'otp'">
            
            <!-- Back Button -->
            <div class="mb-3">
              <a (click)="goBackToEmail()" class="text-primary cursor-pointer d-flex align-items-center">
                <i class="fa fa-arrow-left me-2"></i>
                Change Email
              </a>
            </div>

            <!-- Title -->
            <div class="text-center mb-4">
              <div class="mb-3">
                <i class="fa fa-envelope-open fs-1 text-primary"></i>
              </div>
              <h3 class="mb-2"><b>Verify OTP</b></h3>
              <p class="text-muted">
                We've sent a verification code to
              </p>
              <p class="fw-bold text-dark mb-0">{{ emailAddress }}</p>
            </div>

            <!-- OTP Input -->
            <div class="otp-container mb-4">
              <label class="form-label text-center d-block mb-3">Enter OTP Code</label>
              <div class="otp-inputs d-flex justify-content-center gap-2">
                <input 
                  *ngFor="let i of [0,1,2,3,4,5]"
                  [id]="'otp-' + i"
                  type="text" 
                  maxlength="1" 
                  class="otp-input form-control text-center"
                  (input)="onOtpInput($event, i)"
                  (keydown)="onOtpKeydown($event, i)"
                  (paste)="i === 0 ? onOtpPaste($event) : null"
                  [disabled]="isVerifyingOtp"
                  inputmode="numeric"
                  pattern="[0-9]*" />
              </div>
            </div>

            <!-- Resend OTP -->
            <div class="text-center mb-4">
              <p class="text-muted mb-2">Didn't receive the code?</p>
              <button 
                type="button"
                class="btn btn-link text-primary p-0"
                (click)="resendOtp()"
                [disabled]="resendTimer > 0 || isSubmittingEmail">
                <span *ngIf="resendTimer > 0">Resend in {{ resendTimer }}s</span>
                <span *ngIf="resendTimer === 0 && !isSubmittingEmail">Resend OTP</span>
                <span *ngIf="isSubmittingEmail">Sending...</span>
              </button>
            </div>

            <!-- Verify Button -->
            <div class="d-grid">
              <button 
                type="button" 
                class="btn btn-primary"  
                (click)="verifyOtp()"        
                [disabled]="isVerifyingOtp || otp.length < 4">
                <app-loader-material *ngIf="isVerifyingOtp"></app-loader-material>
                <span>{{ isVerifyingOtp ? 'Verifying...' : 'Verify OTP' }}</span>
              </button>
            </div>

          </div>

          <!-- STEP 3: New Password -->
          <div *ngIf="currentStep === 'newPassword'">
            
            <!-- Back Button -->
            <div class="mb-3">
              <a (click)="goBackToOtp()" class="text-primary cursor-pointer d-flex align-items-center">
                <i class="fa fa-arrow-left me-2"></i>
                Back
              </a>
            </div>

            <!-- Title -->
            <div class="text-center mb-4">
              <div class="mb-3">
                <i class="fa fa-key fs-1 text-primary"></i>
              </div>
              <h3 class="mb-2"><b>Create New Password</b></h3>
              <p class="text-muted">
                Enter your new password below
              </p>
            </div>

            <!-- New Password -->
            <div class="form-group mb-3">
              <label class="form-label" for="newPassword">New Password</label>
              <div class="input-group">
                <input 
                  [type]="showNewPassword ? 'text' : 'password'"
                  class="form-control" 
                  id="newPassword" 
                  placeholder="Enter new password" 
                  [(ngModel)]="newPassword"
                  [disabled]="isResettingPassword"
                  (keyup.enter)="resetPassword()" />
                <span class="input-group-text password-toggle" (click)="togglePasswordVisibility('new')">
                  <i [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword" class="fas"></i>
                </span>
              </div>
              
              <!-- Password Strength Indicator -->
              <div *ngIf="newPassword" class="mt-2">
                <div class="password-strength-bar">
                  <div class="password-strength-fill" 
                       [style.width]="getPasswordStrength(newPassword).width"
                       [style.background-color]="getPasswordStrength(newPassword).color">
                  </div>
                </div>
                <small class="text-muted">
                  Strength: <span [style.color]="getPasswordStrength(newPassword).color" class="fw-semibold">
                    {{ getPasswordStrength(newPassword).text }}
                  </span>
                </small>
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group mb-3">
              <label class="form-label" for="confirmPassword">Confirm Password</label>
              <div class="input-group">
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  class="form-control" 
                  id="confirmPassword" 
                  placeholder="Re-enter password" 
                  [(ngModel)]="confirmPassword"
                  [class.is-invalid]="confirmPassword && newPassword !== confirmPassword"
                  [disabled]="isResettingPassword"
                  (keyup.enter)="resetPassword()" />
                <span class="input-group-text password-toggle" (click)="togglePasswordVisibility('confirm')">
                  <i [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword" class="fas"></i>
                </span>
              </div>
              <small *ngIf="confirmPassword && newPassword !== confirmPassword" class="text-danger">
                <i class="fa fa-exclamation-circle me-1"></i>Passwords do not match
              </small>
            </div>

            <!-- Password Requirements -->
            <div class="password-requirements mb-4">
              <small class="text-muted d-block mb-1">Password must contain:</small>
              <small class="text-muted d-block">
                <i class="fa fa-check-circle me-1" 
                   [class.text-success]="newPassword.length >= 6"
                   [class.text-muted]="newPassword.length < 6"></i>
                At least 6 characters
              </small>
            </div>

            <!-- Reset Button -->
            <div class="d-grid">
              <button 
                type="button" 
                class="btn btn-primary"  
                (click)="resetPassword()"        
                [disabled]="isResettingPassword">
                <app-loader-material *ngIf="isResettingPassword"></app-loader-material>
                <span>{{ isResettingPassword ? 'Resetting Password...' : 'Reset Password' }}</span>
              </button>
            </div>

          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="auth-footer row">
        <div class="col my-1">
          <p class="m-0">Copyright Â©
            <a href="https://lunapackagingltd.co.ke/" target="_blank">Luna Packaging</a>
          </p>
        </div>
        <div class="col-auto my-1">
          <ul class="list-inline footer-link mb-0">
            <li class="list-inline-item">
              <a href="https://lunapackagingltd.co.ke/" target="_blank">Luna Packaging</a>
            </li>
            <li class="list-inline-item">
              <a href="" target="_blank">Privacy Policy</a>
            </li>
            <li class="list-inline-item">
              <a href="" target="_blank">Contact us</a>
            </li>
          </ul>
        </div>
      </div>
      
    </div>
  </div>
</div>